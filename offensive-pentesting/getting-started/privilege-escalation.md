# Privilege Escalation

Наш первоначальный доступ к удаленному серверу обычно осуществляется пользователем с низкими привилегиями, что не дает нам полного доступа через компьютер. Чтобы получить полный доступ, нам нужно будет найти внутреннюю / локальную уязвимость, которая повысит наши привилегии до пользователя root в Linux или администратора / пользователя SYSTEM в Windows. Давайте рассмотрим некоторые общие методы повышения наших привилегий.

## PrivEsc Checklists

Как только мы получим начальный доступ к ящику, мы хотим тщательно перечислить ящик, чтобы найти любые потенциальные уязвимости, которые мы можем использовать для достижения более высокого уровня привилегий. Мы можем найти в Интернете множество контрольных списков и шпаргалок, в которых есть набор проверок, которые мы можем запустить, и команды для выполнения этих проверок. Отличный ресурс - [HackTricks](https://book.hacktricks.xyz/), в котором есть отличный контрольный список для локального повышения привилегий как в [Linux](https://book.hacktricks.xyz/linux-unix/linux-privilege-escalation-checklist), так и в [Windows](https://book.hacktricks.xyz/windows/checklist-windows-privilege-escalation). Еще один отличный репозиторий - [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings), в котором также есть контрольные списки для [Linux](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Linux%20-%20Privilege%20Escalation.md) и [Windows](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md). Мы должны начать экспериментировать с различными командами и методами и познакомиться с ними, чтобы понять многочисленные слабые места, которые могут привести к повышению наших привилегий.

## Enumeration Scripts

Многие из вышеперечисленных команд могут автоматически запускаться со сценарием для просмотра отчета и поиска слабых мест. Мы можем запустить множество скриптов для автоматического перечисления сервера, выполнив общие команды, которые возвращают любые интересные результаты. Некоторые из распространенных скриптов перечисления Linux включают [LinEnum](https://github.com/rebootuser/LinEnum.git) и [linuxprivchecker](https://github.com/sleventyeleven/linuxprivchecker), а для Windows включают [Seatbelt](https://github.com/GhostPack/Seatbelt) и [JAWS](https://github.com/411Hall/JAWS).

Еще один полезный инструмент, который мы можем использовать для перечисления серверов, - это [Privilege Escalation Awesome Scripts SUITE \(PEASS\)](https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite), поскольку он поддерживается в актуальном состоянии и включает сценарии для перечисления как Linux, так и Windows.

{% hint style="info" %}
Эти сценарии будут запускать множество команд, известных для выявления уязвимостей, и создавать много «шума», который может запускать антивирусное программное обеспечение или программное обеспечение для мониторинга безопасности, которое ищет эти типы событий. Это может помешать запуску сценариев или даже вызвать тревогу о взломе системы. В некоторых случаях мы можем захотеть выполнить перечисление вручную вместо запуска скриптов.
{% endhint %}

Давайте возьмем пример запуска Linux-скрипта из PEASS под названием LinPEAS:

```bash
spike@htb[/htb]$ ./linpeas.sh
...SNIP...

Linux Privesc Checklist: https://book.hacktricks.xyz/linux-unix/linux-privilege-escalation-checklist
 LEYEND:
  RED/YELLOW: 99% a PE vector
  RED: You must take a look at it
  LightCyan: Users with console
  Blue: Users without console & mounted devs
  Green: Common things (users, groups, SUID/SGID, mounts, .sh scripts, cronjobs)
  LightMangenta: Your username


====================================( Basic information )=====================================
OS: Linux version 3.9.0-73-generic
User & Groups: uid=33(www-data) gid=33(www-data) groups=33(www-data)
...SNIP...
```

Как мы видим, после запуска скрипт начинает собирать информацию и отображать ее в отличном отчете. Давайте обсудим некоторые уязвимости, которые мы должны искать в выходных данных этих скриптов.

## Kernel Exploits

Всякий раз, когда мы сталкиваемся с сервером под управлением старой операционной системы, мы должны начать с поиска потенциальных уязвимостей ядра, которые могут существовать. Предположим, на сервере не установлены последние обновления и исправления. В этом случае он, вероятно, уязвим для определенных эксплойтов ядра, обнаруженных в непропатченных версиях Linux и Windows.

Например, приведенный выше сценарий показал нам версию Linux 3.9.0-73-generic. Если мы используем эксплойты для этой версии в Google или используем searchsploit, мы найдем CVE-2016-5195, также известную как DirtyCow. Мы можем найти и загрузить эксплойт DirtyCow и запустить его на сервере, чтобы получить root-доступ.

Та же концепция применима и к Windows, поскольку в незащищенных / более старых версиях Windows есть множество уязвимостей, которые можно использовать для повышения привилегий. Мы должны помнить, что эксплойты ядра могут вызвать нестабильность системы, и мы должны быть очень осторожны, прежде чем запускать их в производственных системах. Лучше всего опробовать их в лабораторной среде и запускать в производственных системах только с явным одобрением и согласованием с нашим клиентом.

## Vulnerable Software

Еще нам следует обратить внимание на установленное программное обеспечение. Например, мы можем использовать команду `dpkg -l` в Linux или посмотреть `C:\Program Files` в Windows, чтобы узнать, какое программное обеспечение установлено в системе. Мы должны искать общедоступные эксплойты для любого установленного программного обеспечения, особенно если используются какие-либо старые версии, содержащие незащищенные уязвимости.

## User Privileges

Еще один важный аспект, на который следует обратить внимание после получения доступа к серверу, - это привилегии, доступные пользователю, к которому у нас есть доступ. Предположим, нам разрешено запускать определенные команды как root \(или как другой пользователь\). В этом случае мы можем расширить наши привилегии до пользователей root / system или получить доступ в качестве другого пользователя. Ниже приведены некоторые распространенные способы использования определенных привилегий пользователя:

1. Sudo
2. SUID
3. Windows Token Privileges

Команда sudo в Linux позволяет пользователю выполнять команды от имени другого пользователя. Обычно он используется, чтобы позволить пользователям с более низкими привилегиями выполнять команды от имени пользователя root без предоставления им доступа к пользователю root. Обычно это делается, поскольку определенные команды могут запускаться только от имени пользователя root, например tcpdump, или разрешать пользователю доступ к определенным каталогам только с правами root. Мы можем проверить, какие у нас есть привилегии sudo, с помощью команды sudo -l:

```bash
spike@htb[/htb]$ sudo -l

[sudo] password for user1:
...SNIP...

User user1 may run the following commands on ExampleServer:
    (ALL : ALL) ALL
```

Приведенный выше вывод говорит, что мы можем запускать все команды с помощью sudo, что дает нам полный доступ, и мы можем использовать команду su с sudo для переключения на пользователя root:

```bash
spike@htb[/htb]$ sudo su -

[sudo] password for user1:
whoami
root
```

Приведенная выше команда требует пароля для запуска любых команд с помощью sudo. В определенных случаях нам может быть разрешено запускать определенные приложения или все приложения без необходимости предоставления пароля:

```bash
spike@htb[/htb]$ sudo -l

    (user : user) NOPASSWD: /bin/echo
```

Запись NOPASSWD показывает, что команду / bin / echo можно выполнять без пароля. Это было бы полезно, если бы мы получили доступ к серверу через уязвимость и не знали пароля пользователя. Как говорит пользователь, мы можем запускать sudo от имени этого пользователя, а не от имени пользователя root. Для этого мы можем указать пользователя с помощью -u user:

```bash
spike@htb[/htb]$ sudo -u user /bin/echo Hello World!

    Hello World!
```

Как только мы найдем конкретное приложение, которое можно запустить с помощью sudo, мы сможем найти способы его использования, чтобы получить оболочку в качестве пользователя root. [GTFOBins](https://gtfobins.github.io/) содержит список команд и способы их использования с помощью sudo. Мы можем найти приложение, для которого у нас есть привилегия sudo, и если оно существует, оно может сообщить нам точную команду, которую мы должны выполнить, чтобы получить root-доступ, используя имеющуюся привилегию sudo.

[LOLBAS](https://lolbas-project.github.io/#) также содержит список приложений Windows, которые мы можем использовать для выполнения определенных функций, таких как загрузка файлов или выполнение команд в контексте привилегированного пользователя.

## Scheduled Tasks

